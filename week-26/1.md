08.08.2024

# Logging, monitoring, alerts and status pages


# Logging, Monitoring, Alerts, and Status Pages

## Logging

Logging refers to the practice of recording events, messages, or data points generated by software applications and systems. These logs can include various types of information, such as:

- **Error Messages:** Details about errors and exceptions that occur.
- **Access Logs:** Records of who accessed what resources and when.
- **Audit Logs:** Records for compliance and security purposes.

## Monitoring

Monitoring involves the continuous observation of a system to ensure it is operating correctly and efficiently. It includes tracking various metrics and performance indicators, such as:

- **CPU Usage:** Monitoring how much processing power is being used.
- **Memory Usage:** Tracking the amount of memory being utilized.
- **Disk I/O:** Observing read/write operations on storage devices.
- **Space:** Total amount of space available on the machine.
- **Network Traffic:** Measuring data transfer rates and network activity.
- **Application Performance:** Monitoring response times, throughput, and error rates.

## Alerts

When there are logging and monitoring systems in place, you can set up alerts to notify stakeholders when specific conditions occur, such as:

- A system goes down.
- CPU usage goes above a certain threshold.
- Error count exceeds a predefined limit.
- Disk space falls below a critical level.
- Network traffic spikes unexpectedly.

Alerts can be delivered through various channels like calls, messages, Slack notifications, or paging systems to ensure timely response and action.

Example -> ![backpack](https://status.backpack.exchange/), ![Status](https://status.100xdevs.com/)

# Services
There are a few ways to monitor systems. 
## Paid
- AWS CloudWatch: Monitoring and observability service for AWS resources.
- Datadog - Logging and monitoring
- Newrelic - Logging and monitoring

## In house/self hosted
- Prometheus + Grafana + Loki
 
We’ll be going through
Newrelic
Prom + Grafana

# Newrelic
signup for fresh account

Stack-> linux, we don't have any ec2
create a password

now create a instance on aws 
select an os(ubuntu)
create new key-pair

Launch Instance

download key-pair file

```bash
chmod 700 key-pair.pem
ssh -i aws_machine_link
```

now go back to newrelic
create a new key , install agent on the ubuntu machine by running that command given below

go to new relic dashboard then we can see the agents now

create a new dashboard from the tabl in left
add the agent as per wish

now to add alert

first stop the process on aws machine

right click>create an alert condition>next>name the condition>add threshold data to be put>policy>save

select a workflow-> email, name of destination

# NRQL
NRQL (New Relic Query Language) is a SQL-like query language used to query data within New Relic, a monitoring and observability platform. NRQL allows users to perform complex data analysis and create custom dashboards and alerts by querying their application and infrastructure performance data stored in New Relic.

# CPU Usage
- Fetch all CPU usage
```Newrelic
SELECT average(cpuPercent) AS `CPU used %` FROM SystemSample WHERE (entityGuid = 'xyz') TIMESERIES AUTO
```
- Filter by High CPU Usage
```Newrelic
SELECT average(cpuPercent) AS `CPU used %`
FROM SystemSample
WHERE (entityGuid = 'NDQ2MDY2NXxJTkZSQXxOQXwzOTczMjM4ODc0NzI4NDk0NzYz') AND cpuPercent > 2
TIMESERIES AUTO
```

- Multiple graphs in the same timeline
```Newrelic
SELECT average(transmitBytesPerSecond) AS `Transmit bytes per second`, average(receiveBytesPerSecond) AS `Receive bytes per second` FROM NetworkSample WHERE (entityGuid = 'NDQ2MDY2NXxJTkZSQXxOQXwtMzE2MTI3OTkyNzM3NDEzMTE1Mw') TIMESERIES AUTO
```

- Facet
```Newrelic
SELECT average(cpuPercent) AS `CPU used %`
FROM SystemSample
WHERE entityGuid IN ('xyz', 'abc')
FACET entityGuid
TIMESERIES AUTO
```

# APM - Application Performance Monitoring
Newrelic also lets you see all the logs and stats from your process, not just the host machine

## Default logs
By default, you will see it is tailing `global` nginx logs, but not the application logs
```nginx
/var/log/nginx/access.log
```
## Setting up APM for a Node.js process
- Create  a new data source with Node.js
- Use one of 5 ways to set it up (we’ll go with on the host)
- Install dependencies
```bash 
npm install newrelic express
```

- Update `package.json`
```json
  "scripts": {
    "start": "NEW_RELIC_APP_NAME=test NEW_RELIC_LICENSE_KEY=license_key node -r newrelic index.js"
  },
```

- Create a simple express app
```js
require("newrelic");

const express = require("express");

const app = express();

app.get("/", (req, res) => {
	console.log("route hit");
	res.json({message: "hi there"})
})

app.listen(3000, () => {
	console.log("listening on port 3000");
});
```

- Open another terminal and loadtest the app
```bash
npm i -g loadtest
loadtest -c 10 --rps 200 http://localhost:3000/
```

- Check the APM dashboard, You will notice logs are still empty

## Adding logs
Ref - https://docs.newrelic.com/docs/logs/logs-context/configure-logs-context-nodejs/
- Try enabling the `NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED` flag
```json 
 "scripts": {
    "start": "NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true NEW_RELIC_APP_NAME=test NEW_RELIC_LICENSE_KEY=your_key node -r newrelic index.js"
  },
```

- Add winston as the logger
```bash 
npm install winston
```

- Update the code
```js
require("newrelic");
const winston = require('winston');
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  defaultMeta: { service: 'user-service' },
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple(),
  }));
}

const express = require("express");
const app = express();

app.get("/", (req, res) => {
	logger.info("route hit");
	if (Math.random() < 0.5) {
		logger.error("there was an err");
	}
	res.json({message: "hi there"})
});

app.listen(3000, () => {
	console.log("listening on port 3000");
});
```

go to the terminal, run the node.js process
we have initialised a logger, we can see logs in the terminal

go to logs, click on error, you will see logs in dashboard

# Metrics on logs
You can add metrics on top of log counts (esp for errors) to catch if a certain error is being thrown too often/there is a spike
```newrelic
SELECT count(`message`) FROM Log WHERE (`entity.guid` = 'NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5' OR `entity.guids` LIKE '%NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5%' OR `service_name` = 'test' OR `serviceName` = 'test' OR `service.name` = 'test' OR `entity.name` = 'test') AND (level='error') TIMESERIES AUTO
```

You can also add individual set of metrics on individual errors
```newrelic
AND message LIKE '%there was an error%' 
```

# p95, p99
When you are measuring things like `response times` , `cpu usage`  etc, which of the following should you use?
1. Mean
2. Median
3. Something else?

Let’s say in a 20 second interval there were 20 requests that came and the response times were -
```txt
[1, 2, 3, 4, 4, 4, 5, 6, 7, 9, 10, 11, 11, 11, 12, 13, 13, 13, 50, 100]
```

Copy
Average - 14.45
Median - 9.5

### Better metrics
As you can see, the average is skewed a little to the right because of two anomolies (50, 100)
This means the website is performing good for 90% of the users, but 10% of the users are having slower response times.
- P90 here is 13, since 90% of the users are equal to or below 13ms

Can you guess what P95 would be?
-> P95 is 50, since 95% of the users are equal to or below 50ms

### Percentile based metrics in newrelic
If you open the APM dashboard, you’ll see the response time percentiles tab

# Status pages/Notifiers
Pagerduty and Better stack are two popular services used by teams for `on call` management, raising a call to the manager incase the `on call`is asleep
https://betterstack.com/uptime


# Open Source->
Grafanna, Prometheus and Loki

`https://github.com/grafana/grafana`
`https://prometheus.io/`
`https://github.com/grafana/loki`
